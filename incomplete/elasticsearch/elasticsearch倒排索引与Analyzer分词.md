---
title: "Elasticsearch 倒排索引与Analyzer分词"
date: "2020-01-06"
categories:
    - "技术"
tags:
    - "elasticsearch"
    - "搜索引擎"
    - "概述"
toc: true
---

# Elasticsearch 倒排索引与Analyzer分词
倒排索引（英语：Inverted index），也常被称为反向索引、置入档案或反向档案，是一种索引方法，被用来存储在全文搜索下某个单词在一个文档或者一组文档中的存储位置的映射。它是文档检索系统中最常用的数据结构。

## 示例
以[[英文]]为例，下面是要被索引的文本：
```
T_0 = "it is what it is"
T_1 = "what is it"
T_2 = "it is a banana"
```

我们就能得到下面的反向文件索引：
```
  "a":      {2}
  "banana": {2}
  "is":     {0, 1, 2}
  "it":     {0, 1, 2}
  "what":   {0, 1}
```

检索的条件`what`,`is`和`it`将对应这个[[集合]]：
```
# 取交集
{0,1} {0,1,2} {0,1,2} = {0,1}
```

对相同的文字，我们得到后面这些完全反向索引，由[[文档]]数量和当前查询的单词结果组成的的成对[[数据]]。 
同样，文档数量和当前查询的单词结果都从零开始。所以，`"banana": {(2, 3)}` 就是说 "banana"在第三个文档里 `T_2`，而且在第三个文档的位置是第四个单词 **地址为 3**。
```
 "a":      {(2, 2)}
 "banana": {(2, 3)}
 "is":     {(0, 1), (0, 4), '''(1, 1)''', (2, 1)}
 "it":     {(0, 0), (0, 3), '''(1, 2)''', (2, 0)} 
 "what":   {(0, 2), '''(1, 0)'''}
 ```

如果我们执行短语搜索 `what is it` 我们得到这个短语的全部单词各自的结果所在文档为文档0和文档1。但是这个短语检索的连续的条件仅仅在文档1得到。

倒排索引的核心组成
倒排索引包含两个部分
    单词词典(Term Dictionary), 记录所有文档的单词, 记录单词到倒排列表的关联关系
        单词词典一般比较大, 可以通过 B+树 或 哈希拉链法实现, 以满足高性能的插入与查询
    倒排列表(Posting List) 记录了单词对应的文档结合，由倒排索引项组成
        倒排索引项(Posting)
            文档ID
            词频TF         - 该单词在文档中出现的次数，用于相关性评分
            位置(Position) - 单词在文档中分词的位置，用于语句搜索(phrase query)
            便宜(Offset)   - 记录单词的开始结束位置，实现高亮显示

Elasticsearch的倒排索引
Elasticsearch的JSON文档中的每个字段，都有自己的倒排索引
可以指定对某些字段不做索引
    优点：节省存储空间
    缺点：字段无法被搜索

分词
Analysis 与 Analyzer
Analysis - 文本分析是把全文本转换一系列单词 (term / token) 的过程，也叫分词
Analysis 是通过 Analyzer 来实现的
    可使用 Elasticsearch 内置的分析器 / 或者按需定制化分析器
除了在数据写入时转换词条，匹配 Query语句时候也需要相同的分析器对查询语句进行分析

Analyzer的组成
分词器是专门处理分词的组件，Analyzer由三部分组成
analyzer - 分词器
    ==> character filters  (针对原始文本处理，例如去html)
    ==> tokenizer          (按照规则切分为单词)
    ==> token filters      (将切分的单词进行加工、小写、删除 stopwords、增加同义词)

_analyze api

> 参考列表  
> https://zh.wikipedia.org/wiki/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95  
>