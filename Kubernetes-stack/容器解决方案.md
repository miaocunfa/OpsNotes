---
title: "容器化解决方案"
date: "2020-06-03"
categories:
    - "技术"
tags:
    - "Kubernetes"
    - "容器化"
    - "解决方案"
toc: false
indent: false
original: true
---

## 一、测试环境

### 1.1、前置条件

进行系统内核升级 3.10 --> 4.0+

### 1.2、硬件资源

``` zsh
# 查看内存资源
ansible 23 -m shell -a "free -h| grep Mem | awk '{print $2}'"

# 查看CPU资源
➜  ansible 23 -m shell -a "cat /proc/cpuinfo | grep "processor.*:" | wc -l"
```

### 1.3、规划

Kubernetes版本：1.16.10

| 节点            | 服务                        | 配置   |
| --------------- | --------------------------- | ------ |
| 192.168.100.231 | K8s Node                    | 4C 8G  |
| 192.168.100.232 | K8s Node                    | 4C 8G  |
| 192.168.100.233 | Harbor、Prometheus、grafana | 16C 8G |
| 192.168.100.235 | ELK Cluster、Zabbix Server  | 8C 8G |
| 192.168.100.236 | K8s Master、Ansible         | 4C 4G  |
| 192.168.100.253 | Ceph Server                 |        |

### 1.4、私有镜像库

搭建Harbor作为私有镜像库

#### 1.4.1、Harbor Server Info

``` info
    IP:   192.168.100.233
    user: admin
    pass: Harbor123
```

#### 1.4.2、Harbor Server 操作

``` zsh
➜  cd /root/harbor

# 启动Harbor
➜  docker-compose up
➜  docker-compose ps
      Name                     Command                  State       Ports
------------------------------------------------------------------------------------------------------------------------------------
chartmuseum         /docker-entrypoint.sh            Up (healthy)   9999/tcp
clair               /docker-entrypoint.sh            Up (healthy)   6060/tcp, 6061/tcp
harbor-core         /harbor/start.sh                 Up (healthy)
harbor-db           /entrypoint.sh postgres          Up (healthy)   5432/tcp
harbor-jobservice   /harbor/start.sh                 Up
harbor-log          /bin/sh -c /usr/local/bin/ ...   Up (healthy)   127.0.0.1:1514->10514/tcp
harbor-portal       nginx -g daemon off;             Up (healthy)   80/tcp
nginx               nginx -g daemon off;             Up (healthy)   0.0.0.0:443->443/tcp, 0.0.0.0:4443->4443/tcp, 0.0.0.0:80->80/tcp
notary-server       /bin/server-start.sh             Up
notary-signer       /bin/signer-start.sh             Up
redis               docker-entrypoint.sh redis ...   Up             6379/tcp
registry            /entrypoint.sh /etc/regist ...   Up (healthy)   0.0.0.0:5000->5000/tcp
registryctl         /harbor/start.sh                 Up (healthy)
➜  docker-compose down
```

#### 1.4.3、目标

1、完成私有镜像库的搭建  
2、完成应用镜像化  

### 1.5、分布式存储

搭建Ceph分布式存储为K8s集群提供存储服务

#### 1.5.1、Ceph Info

``` info
    IP: 192.168.100.253
```

#### 1.5.2、目标

1、完成分布式存储的搭建  
2、提供ceph的对象存储  
3、提供ceph的rbd存储  
4、使用ceph-rbd实现kubernetes集群pv动态供给  

### 1.6、日志监控系统

使用EFK技术栈来实现日志监控系统

#### 1.6.1、EFK Info

``` info
    elasticsearch: 192.168.100.235:9200
    kibana:        192.168.100.235:5601
    fluentd：      Node节点启用的日志收集器
```

#### 1.6.2、EFK 操作

``` zsh
# elasticsearch Server
➜  su - elasticsearch
➜  cd /opt/elasticsearch-7.1.1/bin
➜  ./elasticsearch -d

# kibana Server
➜  cd /opt/kibana-7.1.1-linux-x86_64/bin
➜  nohup ./kibana serve &

# fluentd
# 在k8s集群中启动fluentd的ds副本即可
```

#### 1.6.3、目标

1、完成系统搭建  
2、实现k8s集群内应用日志的收集、展示  
3、使用ansible playbook实现整个ELK系统的重启  

### 1.7、监控告警系统

使用Prometheus技术栈实现监控告警系统

#### 1.7.1、Prometheus Info

``` info
    Prometheus Server: 192.168.100.233:9090
    grafana:           192.168.100.233:3000
    alertmanager:      192.168.100.233
    node_export:       K8s-Node   9100
                       非K8s-Node 10091
```

#### 1.7.2、Prometheus 操作

``` zsh
# Prometheus Server
➜  cd /usr/local/prometheus-2.13.1.linux-amd64
➜  nohup ./prometheus --storage.tsdb.retention=180d --web.enable-admin-api &

# grafana Server
➜  cd /usr/local/grafana-6.4.4/bin
➜  nohup ./grafana-server &

# alertmanager Server
➜  cd /usr/local/alertmanager-0.19.0.linux-amd64
➜  nohup ./alertmanager &

# Node_exporter Server
# 非k8s节点，监听10091端口
➜ cd /opt/node_exporter-0.18.1.linux-amd64
➜ nohup ./node_exporter --web.listen-address=":10091" &

# k8s节点，监听9100端口
# 在k8s集群中启动node_exporter的ds副本即可
```

#### 1.7.1、目标

1、完成系统搭建  
2、使用prometheus实现对整个测试环境的指标监控、告警  
3、使用ansible playbook实现整个监控系统的重启  
node_exporter服务启动  
prometheus服务启动  
grafana服务启动  

## 二、生产环境

### 2.1、前置条件

生产环境经典网络切换为VPC网络

### 2.2、节点规划

## 三、应用容器化

### 3.1、Dockerfile

### 3.2、Deploy yaml

## 四、常见问题
